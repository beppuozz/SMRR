// $Id: DetectorConstruction.cc 94 2010-01-26 13:18:30Z adotti $
/**
 * @file
 * @brief Implements mandatory user class DetectorConstruction.
 */

#include "DetectorConstruction.hh"
#include "DetectorMessenger.hh"

#include "G4Material.hh"
#include "G4Box.hh"
#include "G4LogicalVolume.hh"
#include "G4PVPlacement.hh"
#include "G4PVReplica.hh"

#include "G4GeometryTolerance.hh"
#include "G4GeometryManager.hh"
#include "G4NistManager.hh"

#include "G4VisAttributes.hh"
#include "G4Colour.hh"

#include "SensitiveDetector.hh"
#include "G4SDManager.hh"

DetectorConstruction::DetectorConstruction()
  : vacuum(0) 
  , LaBr3_Mat(0)
  , logicWorld(0)
  , halfWorldLength(0.5*km)
{
  //Create a messanger (defines custom UI commands)
  messenger = new DetectorMessenger(this);
  
  //--------- Material definition ---------
  DefineMaterials();
  
  //            	//--------- Sizes of the principal 
  //              geometrical components (solids)  ---------
  ComputeParameters();
}

DetectorConstruction::~DetectorConstruction()
{
  delete messenger;
  delete LaBr3_Mat;

}

void DetectorConstruction::DefineMaterials() 
{
  //Get Materials from NIST database
  G4NistManager* man = G4NistManager::Instance();
  man->SetVerbose(10);
  
  // define NIST materials
  
  //// 1 - Lantanum (L) /////////////
  
  //Retrieving Lantanum from G4NIST Material

  G4int LantanumZ = 57;
  
  G4Element* L = man->FindOrBuildElement(LantanumZ);
  
  if(L) G4cout << "Lantanum correctly retrieved" << G4endl;

   /// 2 - Bromide (Br) //////
  
  G4int BromideZ = 35;

  G4Element* Br = man->FindOrBuildElement(BromideZ);

  if(Br) G4cout << "Bromide correctly retrieved" << G4endl;  

  G4cout << "Building LaBr3 Material" << G4endl;

  G4double LaBr3_density = 5.06* g/cm3; // mean LaBr3 density
  
  G4int LaBr3_comp_Atoms = 2;
  G4int n_La_Atoms = 1;
  G4int n_Br_Atoms = 3;
  
  LaBr3_Mat = new G4Material("LaBr3Mat", LaBr3_density, LaBr3_comp_Atoms);

  LaBr3_Mat->AddElement(L,n_La_Atoms);
  LaBr3_Mat->AddElement(Br,n_Br_Atoms);
  
  if (!LaBr3_Mat)   G4cout << "Problems making LaBr3 Material " << G4endl;


    /// 3 - Retrieving vacuum from G4NIST database

  vacuum  = man->FindOrBuildMaterial("G4_Galactic");
}
 
void DetectorConstruction::ComputeParameters() 
{
  //This function defines the defaults
  //of the geometry construction
  
  // ** world **
  halfWorldLength = 500*m;
  
    
  //LaBr3 Detector

  halfLaBr3Det_x = 1.905* cm;
  halfLaBr3Det_y = 1.905* cm;
  halfLaBr3Det_z = 2.540* cm;
  
}

G4VPhysicalVolume* DetectorConstruction::Construct()
{
	//This function is called by G4 when the detector has to be created
	//--------- Definitions of Solids, Logical Volumes, Physical Volumes ---------


  ///------WORLD-------------------------------------///
  
  
  G4GeometryManager::GetInstance()->SetWorldMaximumExtent(2.*halfWorldLength);
  G4cout << "Computed tolerance = "
	 << G4GeometryTolerance::GetInstance()->GetSurfaceTolerance()/mm
	 << " mm" << G4endl;

  
  //Define Box for the world
  G4Box * solidWorld= new G4Box("world",
				halfWorldLength,  //half x dimension
				halfWorldLength,  //half y dimension
				halfWorldLength); //half z dimension
  
  
  logicWorld= new G4LogicalVolume(solidWorld, //corresponding G4Solid 
				  vacuum,      //corresponding G4Material: 
				               //              I set vacuum
				  "World",    //Name
				  0,          //FieldMamanger
				  0,          //Sensitive detector
				  0,          //User limits
				  0);         //Optimise
  
  
  //  Must place the World Physical volume unrotated at (0,0,0).
  //
  G4VPhysicalVolume* physiWorld 
    = new G4PVPlacement(0,               // no rotation
			G4ThreeVector(), // at (0,0,0)
			logicWorld,      // its logical volume
			"World",         // its name
			0,               // its mother  volume
			false,           // no boolean operations
			0);              // copy number
  
  
    
  //--------- Visualization attributes -------------------------------
  
  G4Color
    green(0.0,1.0,0.0),
    blue(0.0,0.0,1.0),
    brown(0.4,0.4,0.1),
    white(1.0,1.0,1.0);
  
  logicWorld -> SetVisAttributes(new G4VisAttributes(white));
  logicWorld -> SetVisAttributes(G4VisAttributes::Invisible);
  
  
    
  //always return the physical World!!!!!!!!!!!!!!!!!1
  //the typedef of this method is G4VPhysicalVolume
  
  //Call the method to construct all the rest
  
  Construct_LaBr3Detector();
    
  
  return physiWorld;
}

G4VPhysicalVolume* DetectorConstruction::Construct_LaBr3Detector()
    {
     
      G4Color
	green(0.0,1.0,0.0),
 	blue(0.0,0.0,1.0),
 	brown(0.4,0.4,0.1),
 	white(1.0,1.0,1.0);
      
      

      //*****************Create the LaBr3 Detector ****************************//
                 
      G4Box * solidLaBr3Det = new G4Box("solid_LaBr3Det",
					halfLaBr3Det_x,
					halfLaBr3Det_y,
					halfLaBr3Det_z);
      
      logicLaBr3 = 
	new G4LogicalVolume(solidLaBr3Det,        // its solid
			    LaBr3_Mat,	        //its material --> PE Converter
			    "logic_LaBr3");	//its name
      
      G4int LaBr3_copynum = 1;

      physiLaBr3 = new G4PVPlacement(0,	//no rotation
					G4ThreeVector(), //put at 0,0,0
					logicLaBr3,//its logical volume
					"physical_LaBr3",   //its name
					logicWorld,	    //its mother  volume
					false,	    //no boolean operation
					LaBr3_copynum);		    //copy number
      
      
      logicLaBr3 -> SetVisAttributes(new G4VisAttributes(green));

      //**************************************************************//

     
     //Define The LaBr3 detector as Sensitive Detector

     static SensitiveDetector* sensitive = 0;
     if ( !sensitive) 
       {
	 G4cout << "DECLARING SENSITIVE DETECTOR" << G4endl;
	 sensitive = new SensitiveDetector("/myDet/ArCO2");
	 //We register now the SD with the manager
	 G4SDManager::GetSDMpointer()->AddNewDetector(sensitive);
	 G4cout << "SENSITIVE DETECTOR ADDED" << G4endl;
       }
  
     
     logicLaBr3->SetSensitiveDetector(sensitive);
     
     return physiLaBr3 ;
   }

#include "G4RunManager.hh"
#include "G4PhysicalVolumeStore.hh"
#include "G4LogicalVolumeStore.hh"
#include "G4SolidStore.hh"

void DetectorConstruction::UpdateGeometry()
{
  // Cleanup old geometry
  G4GeometryManager::GetInstance()->OpenGeometry();
  G4PhysicalVolumeStore::GetInstance()->Clean();
  G4LogicalVolumeStore::GetInstance()->Clean();
  G4SolidStore::GetInstance()->Clean();

  G4RunManager::GetRunManager()->DefineWorldVolume(Construct());


}
